1. Архитектура 

Для добавления методов авторизации используется плагинная архитектура. Это сделано для того, чтобы очень быстро, практически не меняя существующий код внедрять новые методы авторизации. Новые методы внедряются с помощью наследованния от метакласса AuthMethod. Все остальное сделано по обычным паттернам.

2. Регистрация через email

Чтобы зарегистрироваться через email надо дернуть ручку /email/registrate. Туда передается email и пароль через json. Регистрация через email доступна для незарегестрированных пользователей или для пользователей у которых определены методы регистрации, но не email. Возможны несколько исходов регистрации:

    1. Успешно - 201

    Если пользователь зарегестрирован. Ему отправляется письмо для подтверждения почты, где есть ссылка, переходя нна которую происходит подтверждение.

    2. Успешно - 200
  
    Если пользщователь уже регестрировался, но не подтвердил свою почту. Ему отправляется повторное письмо, где есть новый линк. 

    3. AlreadyExists - 409

    Если пользователь уже зарегистрироваля и подтвердил почту.

    4. ObjectNotFound - 404

    Если указано для какого пользователя добавить метод регистрации и этого пользователя не существует.

    5. SessionExpired - 403

    Если указано для какого пользователя добавить метод регистрации, указана его сессия, которая, в свою очередь, протухла.

При любом исходе возвращает т.н ResponseModel = {status: str, message: str}

3. Логин через email. 

Чтобы залогиниться надо дернуть ручку email/login. Туда передается email, password. Что может быть, если дернуть ручку:

    1. AuthFailed - 401

    Если логин+пароль неправильный или если пользователь не подтвердил email.

    2. Успешно - 200

    Возвращает в таком случае объект UserSession = {id: int, token: str, expires: datetime}

4. Смена пароля

Чтобы поменять пароль, существует два варианта: либо поменять его из открытой сессии: нужен email, password, new_password, token, либо в случае забытого пароля можно пользоваться только email.

    1. Восстановление без сессии

    Надо дернуть ручку /email/password/reset/request, передать туда email. На почту приходит письмо со ссылкой на фронт, где можно поменять пароль, там     есть reset_token в ссылке. Далее этот токен надо отправить в ручку /email/password/reset, туда отправляется email, reset_token в хедере, new_password в json. 
    2. Восстановление с сессией
    
    Надо дернуть ручку /email/password/reset/request, передать туда email, token, password, new_password. Пароль просто поменяется, придет письмо об этом.
    
    3. Ручка /email/password/reset/request может кидать:
            1. SessionExpired - 403, если переданная сессия закончилась
            2. 401, Auth method restricted for this user
            3. AuthFailed - 401, Incorrect password  || Registration wasn't completed.
            4. 403, Incorrect user session, если переданная сессия не принадлежит юзеру.
            5. Успешно - 200, Возвращает ResponseModel
            6. 404, Email not found
            
    4. Ручка /email/password/reset может кидать:
            1. 404, Email not found
            2. 403, Incorrect reset token
            3. Успешно - 200, возвращает ResponseModel
5. Смена почты 

Чтобы поменять почту, надо дернууть ручку /email/reset/email/request, туда передается новая почта и токен. На новую почту приходит письмо, в котором лежит ссылка на подтверждение новой почты. Ссылка на ручку /email/reset/email.

        1. Ручка /email/reset/email/request:
                1. 401, Unauthorized, если сессия не передана
                2. SessionExpired - 403
                3. IncorrectUserAuthType - 403, у юзера нет такого способа входа
                4. AuthFailed - 401, Registration wasn't completed
                5. 401, Email incorrect
                6. Успешно - 200
         2. Ручка /email/reset/email
                1. AuthFailed - 401
                2. 403, Incorrect new email || Incorrect confirmation token
                3. Успешно - 200
